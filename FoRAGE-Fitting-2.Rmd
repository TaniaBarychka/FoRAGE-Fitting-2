---
title: "FoRAGE Fitting-2"
author: "TaniaBarychka"
date: "26 February 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This is to carry on fitting FoRAGE database, in particular dealing with poor fit of handling times. 


```{r echo=FALSE, warning=FALSE, message=FALSE}

library (ggplot2)
library(dplyr)          # for data manipulation
library(tidyr)          # for data shaping
library(ggpubr)
library(gridExtra)
library(car)
library(lattice)
library(car)
library(outliers)
library (gridExtra)

#install.packages("devtools")
#devtools::install_github("cardiomoon/ggiraphExtra")
require(ggiraph)
require(ggiraphExtra)
#require(plyr)


#work desktop
#source("C:/Users/Tania Barychka/OneDrive/Desktop/HighstatLibV10.R")

#home desktop
source("C:/Users/Etherian/OneDrive/Desktop/HighstatLibV10.R")


#small laptop
#source("C:/Users/tatsi/OneDrive/Desktop/HighstatLibV10.R")

# Create customized color palette
library(RColorBrewer)
mycol = c(brewer.pal(name="Dark2", n = 8), brewer.pal(name="Paired", n = 6))
```



```{r echo=FALSE}
#work
#forage_db<- read.csv("C:/Users/Tania Barychka/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#summary(forage_db)


#home
forage_db<- read.csv("C:/Users/Etherian/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#laptop
#forage_db<- read.csv("C:/Users/Tania/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#small laptop
#forage_db<- read.csv("C:/Users/tatsi/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

forage_db<-forage_db[-c(2084:2682),]
table(forage_db$Major.grouping.1)
```


```{r echo=FALSE,fig.width=10, fig.height=10}

#I'll convert body masses and rates to NATURAL locarithms.

#reduce data set to the variables we're interested in. 
forage_db$L.PredBM<-log(forage_db$Predator.mass..mg.)
forage_db$L.PreyBM<-log(forage_db$Prey.mass..mg.)
forage_db$L.Fitted.a..median.of.BS.samples.<-log(forage_db$Fitted.a..median.of.BS.samples.)
forage_db$L.Fittted.h..day.<-log(forage_db$Fittted.h..day.)

#I'll remove angiosperms, protozoans and Nas.

forage_db<-forage_db[forage_db$Vert.invert!="Angiosperm" ,]

#Arrhenius
#deduct To = 293.15K

To<-293.15

#devide by *kTTo
k<-0.00008617

#convert
forage_db$temp_K<-forage_db$Temp..C..+273.15
forage_db$temp_A<-(forage_db$temp_K-To)/(k*forage_db$temp_K*To)



df<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$temp_A))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df)<-c("L.PredBM", "L.PreyBM", "L.Fittted.h..day.", "temp_A")

#add ecto and endotherms
forage_db$EctoEndo<-ifelse(forage_db$Major.grouping.1=="Bird" | forage_db$Major.grouping.1=="Mammal", "Endo", "Ecto" )


table(forage_db$Vert.invert)

df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert
df$EctoEndo<-forage_db$EctoEndo
```

One of the commonest reasons for a lack of fit is through the existence of outliers in the data. It is important to understand howevre, that a point way *appear* to be an outlier becasue of teh **misspecification of the model**, and not because there is anything wrong with the data. 

It is important to understand that **analysis of residuals is a very poor way of looking for influence**. Precisely because a point is highly influential, it **forces the regression line close to it, and hence the influential point may have very small residual.** 


I'll begin by identifying points that appear to be outliers on the plots of log-fitted handling times vs:

- log-prey bodymass
- log-predator bodymass
- log-temperature

**As a function of Prey bodymass**
(code from https://rpubs.com/RatherBit/188960)

```{r echo=FALSE, fig.width=10, fig.height=7}

#prey
plot(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM, col="lightblue", pch=19, cex=2)

### this add the labels to the points using their rownames
### font = 2 is bold

text(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM, labels=rownames(forage_db),data=forage_db, cex=0.6, font=5)



a<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Habitat))+ theme(panel.border = element_blank(),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_rect(colour="white", fill="white"), strip.text.x = element_text(size = 14), legend.position = "top", legend.title=element_blank())

#+theme_bw(base_size = 13, base_family = "")

#ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Mean.R2.of.fits))

#ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Major.grouping.1.1))

b<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$EctoEndo))+ theme(panel.border = element_blank(),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_rect(colour="white", fill="white"), strip.text.x = element_text(size = 14), legend.position = "top", legend.title=element_blank())
#+theme_bw(base_size = 13, base_family = "")


grid.arrange(a, b, ncol=2)
```


```{r echo=FALSE, eval=FALSE}

p<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1))+geom_boxplot_interactive()


##for inetractive plot (print in console)

p<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1, fill=Major.grouping.1.1, data_id=Major.grouping.1.1))+geom_boxplot_interactive(outlier.colour = "red")+
  guides(fill = "none") + theme_minimal()+xlab("Ln Prey Bodymass")+ylab("Ln Fitted handling times")


x <- girafe(ggobj = p)
if( interactive() ) print(x)


```



```{r echo=FALSE,fig.width=10, fig.height=7}

p<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1))+geom_boxplot_interactive()


##for inetractive plot (print in console)

p<-ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1, fill=Major.grouping.1.1, data_id=Major.grouping.1.1))+geom_boxplot_interactive(outlier.colour = "red") + theme_minimal()+xlab("Ln Prey Bodymass")+ylab("Ln Fitted handling times")+theme(legend.position = "bottom")
p


#xyplot(L.Fittted.h..day.~L.PreyBM|Major.grouping.1.1, type="p", data=forage_db)

```


It looks like that prey type could be significant : once prey has been binned into types the trend of increasing handling times with prey body mass is more evident and the variation is due to outliers.

I'll re-fit **Handling Times~Prey Body mass + Prey Type** (Kalinoski and DeLong, 2016):

```{r echo=FALSE,fig.width=10, fig.height=7}

df_new<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df_new)<-c("L.PredBM", "L.PreyBM", "L.Fitted.a..median.of.BS.samples.", "L.Fittted.h..day.", "Temp..C..")


df_new<-as.data.frame(df_new)

df_new$VertInvert<-forage_db$Vert.invert
df_new$EctoEndo<-forage_db$EctoEndo
df_new$PreyType<-as.factor(forage_db$Major.grouping.1.1)

df_no<-df_new[df$VertInvert!="" | df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)

```


```{r echo=FALSE,fig.width=10, fig.height=7}
ht3<-lm(L.Fittted.h..day.~PreyType+L.PreyBM, data=df_na)
drop1(ht3, test="F")


summary(ht3)

op<-par(mfrow=c(2,2))

plot(ht3)

E<-rstandard(ht3)

hist(E)
qqnorm(E)

plot(E~df_na$L.PreyBM)
plot(E~df_na$PreyType)

par(op)

```

The model looks poor. 

**Predator**

Samraat P. suggested focusing on predator rather than prey body masses.


```{r echo=FALSE, fig.width=10, fig.height=7}
#predator
plot(forage_db$L.Fittted.h..day.~forage_db$L.PredBM, col="lightgreen", pch=19, cex=2)

### this add the labels to the points using their rownames
### font = 2 is bold

text(forage_db$L.Fittted.h..day.~forage_db$L.PredBM, labels=rownames(forage_db),data=forage_db, cex=0.6, font=5)

c<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Habitat))+ theme(panel.border = element_blank(),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_rect(colour="white", fill="white"), strip.text.x = element_text(size = 14), legend.position = "top", legend.title=element_blank())

#+theme_bw(base_size = 13, base_family = "")

#ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Mean.R2.of.fits))

#ggplot(forage_db, aes(L.PreyBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$Major.grouping.1.1))

d<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.))+geom_point(aes(col=forage_db$EctoEndo))+ theme(panel.border = element_blank(),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_rect(colour="white", fill="white"), strip.text.x = element_text(size = 14), legend.position = "top", legend.title=element_blank())
#+theme_bw(base_size = 13, base_family = "")

grid.arrange(c, d, ncol=2)

```

The relationships with predator bodymass is less clear than with prey body masses. Like with prey body mass there appears to be a band of animals that are relatively big in size but have very small handling times. On the other hand we have some animals that are relatively small but have quick handling times.



```{r echo=FALSE,fig.width=10, fig.height=7}

e<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1))+geom_boxplot_interactive()


##for inetractive plot (print in console)

e<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.,tooltip=Major.grouping.1.1, fill=Major.grouping.1.1, data_id=Major.grouping.1.1))+geom_boxplot_interactive(outlier.colour = "red") + theme_minimal()+xlab("Ln Predator Bodymass")+ylab("Ln Fitted handling times")+theme(legend.position = "bottom",legend.title=element_blank())+ggtitle("Grouped by Prey Type")
e



#xyplot(L.Fittted.h..day.~L.PreyBM|Major.grouping.1.1, type="p", data=forage_db)

```




```{r echo=FALSE,fig.width=10, fig.height=7, eval=FALSE}
#**Grouped by Predator Type**

f<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.,tooltip=Major.grouping.1))+geom_boxplot_interactive()


##for inetractive plot (print in console)

f<-ggplot(forage_db, aes(L.PredBM,L.Fittted.h..day.,tooltip=Major.grouping.1, fill=Major.grouping.1.1, data_id=Major.grouping.1.1))+geom_boxplot_interactive(outlier.colour = "red") + theme_minimal()+xlab("Ln Predator Bodymass")+ylab("Ln Fitted handling times")+theme(legend.position = "bottom",legend.title=element_blank())
f


#xyplot(L.Fittted.h..day.~L.PreyBM|Major.grouping.1.1, type="p", data=forage_db)

```


The plot above shows what happens if we assume that predators in the same body mass classes preyed on a certain prey species exclusively. I.e. assumes underlying relationships between predator body mass and prey type.

**Handling times~Predator Body mass + Prey Type**


```{r echo=FALSE,fig.width=10, fig.height=7}

ht4<-lm(L.Fittted.h..day.~PreyType+L.PredBM, data=df_na)
drop1(ht4, test="F")


summary(ht4)

op<-par(mfrow=c(2,2))

plot(ht4)

E<-rstandard(ht4)

hist(E)
qqnorm(E)

plot(E~df_na$L.PredBM)
plot(E~df_na$PreyType)

par(op)

```

This model is not great either.

Samraat also suggested collapsing prey by each predator (assuming we have multiple measurements of prey per predator). The idea is to take the smallest handling time (=optimal) because it takes a long time for models of handling time to converge on the optimum. This should hopefully help with the variability.






**Cook's distance**


The cook’s distance for each observation *i* measures the change in Y^ (fitted Y) for all observations with and without the presence of observation i, so we know how much the observation i impacted the fitted values. In general use, those observations that have a cook’s distance greater than 4 times the mean may be classified as influential. This is not a hard boundary.

In full model: http://r-statistics.co/Outlier-Treatment-With-R.html

```{r echo=FALSE,fig.width=10, fig.height=10}
mod <- lm(L.Fittted.h..day. ~ ., data=df)
cooksd <- cooks.distance(mod)

plot(cooksd, pch="*", cex=1, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red", cex = 0.9)  # add labels

influential_Full<- as.numeric(names(cooksd)[(cooksd > 4*mean(cooksd, na.rm=T))])  # influential row numbers
head(df[influential_Full, ])  # influential observations.

```

We get 79 influential values **based on the model that includes prey, predator and arrhenius temp.**

The function outlierTest from car package gives the most extreme observation based on the given model. Here’s an example based on the mod linear model object we’d just created.

The outliers package provides a number of useful functions to systematically extract outliers.

```{r echo=FALSE}

outlierTest(mod)

set.seed(1234)

#outliers gets the extreme most observation from the mean
outlier(df$L.PredBM)

s<-scores(df$L.Fittted.h..day., type = "chisq", prob=0.95)

#which(s[s==TRUE])
```


I would like to see whether values identified as influential based on the model(s) form part of a group in the database.

I should also look at other models: Ht~Prey Bodymass; HT~PreyBody mass.


```{r echo=FALSE}

inf_df<-forage_db[forage_db$Data.set %in%  influential_Full,]

table(inf_df$Major.grouping.1)

plot(inf_df$L.PreyBM,inf_df$L.Fittted.h..day.)


```

I'm not sure Cooke's distance is all that helpful here. I'm going to

**Individual values**

Most handling times are between -15 and 0 with handling times increasing with prey body mass. 

However, there appears to be 'a group' of animals with handling times below -12 to -15: animals that are realtively large but aee consumed very quickly. Who might they be?

There appears to be some prey animlas that are gobbled up very quickly despite being of medium size,e.g. we have animals of over 3kg in size that are eaten as quickly as animals 0.00005mg in size. Hard to believe it's likely. 

One possible explanation could be units error.


I'm going to dip into cluster analysis very quickly and then go thorugh values from right to left (large prey with very small handling times).


```{r echo=FALSE,fig.width=10, fig.height=10}

op<-par(mfrow=c(2,2))



km3<-kmeans(data.frame(df_na$L.PreyBM, df_na$L.Fittted.h..day.),3)
plot(df_na$L.PreyBM, df_na$L.Fittted.h..day., col=km3[[1]])


km4<-kmeans(data.frame(df_na$L.PreyBM, df_na$L.Fittted.h..day.),4)
plot(df_na$L.PreyBM, df_na$L.Fittted.h..day., col=km4[[1]])

km5<-kmeans(data.frame(df_na$L.PreyBM, df_na$L.Fittted.h..day.),5)
plot(df_na$L.PreyBM, df_na$L.Fittted.h..day., col=km5[[1]])


km6<-kmeans(data.frame(df_na$L.PreyBM, df_na$L.Fittted.h..day.),6)
plot(df_na$L.PreyBM, df_na$L.Fittted.h..day., col=km6[[1]])
par(op)
```


```{r echo=FALSE, fig.width=10, fig.height=10, eval=FALSE}
#Discriminant analysis
library(MASS)

#remove attack rate
df_na_r<-df_na[,-c(3,6:8)]

model<-lda(L.Fittted.h..day.~., data = df_na_r)
plot(model, col=rep(1:6, each=30))

model


#too much overlap and not enough discrimination. 
```





I'm going to look at values for handling time of ln(ht)<=-15 and check if they make sense and perhaps belong to a group.

```{recho=FALSE,fig.width=10, fig.height=10}

sSet_df<-forage_db[forage_db$L.Fittted.h..day.<=-15,]

##subset 1##
sSet_df_gr1<-sSet_df[sSet_df$L.PreyBM>=0,]

#par(mfrow=c(2,2))

# plots
gg_point = ggplot(data = sSet_df_gr1)+geom_point_interactive(aes(x = L.PreyBM, y = L.Fittted.h..day., color=Habitat, shape=Vert.invert,tooltip = Data.set, data_id = Data.set)) + theme_minimal()

x<-girafe(ggobj = gg_point)
if( interactive() ) print(x)

#ggplot(sSet_df_gr1, aes(L.PreyBM,L.Fittted.h..day.,col=Habitat))+geom_point_interactive()



##Sub-set 2##

sSet_df_gr2<-sSet_df[sSet_df$L.PreyBM<0 & sSet_df$L.PreyBM>=-15,]

#par(mfrow=c(2,2))

# plots
gg_point = ggplot(data = sSet_df_gr2)+geom_point_interactive(aes(x = L.PreyBM, y = L.Fittted.h..day., color=Habitat, shape=Vert.invert,tooltip = Data.set, data_id = Data.set)) + theme_minimal()

x<-girafe(ggobj = gg_point)
if( interactive() ) print(x)

#ggplot(sSet_df_gr2, aes(L.PreyBM,L.Fittted.h..day.,col=Habitat))+geom_point_interactive()


```

```{r echo=FALSE}

sSet_new<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(sSet_new)<-c("L.PredBM", "L.PreyBM", "L.Fittted.h..day.", "Temp..C..")

sSet_new<-as.data.frame(sSet_new)

df_new$VertInvert<-forage_db$Vert.invert
df_new$EctoEndo<-forage_db$EctoEndo
df_new$PreyType<-as.factor(forage_db$Major.grouping.1.1)

df_no<-df_new[df$VertInvert!="" | df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)


max(sSet_df$L.PreyBM)
#summary(sSet_df)

table(sSet_df$Vert.invert, sSet_df$Habitat)

```


```{r echo=FALSE, eval=FALSE}

modPrey<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM)
summary(modPrey)


#I look at the most extreme values of the explanatory variable (Prey Body mass) both to the left (extreme low values) and the right (extreme high values), as judged by (x-xmean)^2:
iM<-influence.measures(modPrey)
#extract 
iM$is.inf[iM$is.inf==TRUE]

#for plotting
which(apply(iM$is.inf,1,any))

lmIn<-lm.influence(modPrey)

#the actual values of handling times
df$L.Fittted.h..day.[which(apply(iM$is.inf,1,any))]

#tha actual values of prey body mass
df$L.PreyBM[which(apply(iM$is.inf,1,any))]

summary(iM)

#plot
yp<-df$L.Fittted.h..day.[which(apply(iM$is.inf,1,any))]
xp<-df$L.PreyBM[which(apply(iM$is.inf,1,any))]
plot(df$L.PreyBM, df$L.Fittted.h..day., pch=16)

points(xp, yp, col="red", cex=1.3, pch=16)
abline(modPrey)


#outliers with car function
outlierTest(modPrey)

```



